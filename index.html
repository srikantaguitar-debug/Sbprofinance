<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Finance System - Mobile App</title>

    <meta name="theme-color" content="#007ACC"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="ProFinance">
     
    <link rel="apple-touch-icon" href="icon-192x192.png"> 
    <link rel="manifest" href="manifest.json">
     
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
     
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
     
    <style>
        /* --- General Variables and Reset (FinTech 3.0 Theme) --- */
        :root {
            --primary: #00B894;
            --danger: #E84118;
            --info: #007ACC;
            --warning: #FDCB6E;
            --bg-body: #F7F9FC;
            --bg-card: #FFFFFF;
            --text-main: #1C2833;
            --text-muted: #62727D;
            --radius: 12px;
            --shadow: 0 5px 15px -5px rgba(44, 58, 71, 0.1);
            --shadow-btn: 0 4px 10px -2px rgba(0, 122, 204, 0.4);
            --lock-bg: #E6F0FF;
            --lock-text: #007ACC;
        }

        html, body, #securityOverlay { height: 100%; }

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            margin: 0; padding: 0; 
            -webkit-font-smoothing: antialiased;
            overflow: auto; 
        }

        .container { 
            width: 100%; max-width: 600px; margin: 0 auto; 
            padding: 15px; min-height: 100vh; box-sizing: border-box;
        }
        .card { 
            background: var(--bg-card); 
            border-radius: var(--radius); 
            padding: 18px; 
            box-shadow: var(--shadow); 
            margin-bottom: 15px; 
            border: 1px solid #E0E0E0; 
            transition: all 0.3s;
        }
        
        /* Header */
        header { 
            text-align: center; padding: 15px 18px; margin-bottom: 20px; 
            background: #E6F0FF; border-radius: var(--radius);
            box-shadow: 0 6px 15px rgba(0, 122, 204, 0.1); 
            border: 2px solid var(--info); color: var(--info);
        }
        header p { color: var(--info); font-weight: 600; margin: 0; }
        .balance { 
            font-size: 32px; font-weight: 800; margin: 5px 0 0; 
            transition: color 0.3s; color: var(--info);
        }
        .balance.positive { color: var(--primary); }
        .balance.negative { color: var(--danger); }
        .balance.zero { color: var(--info); }

        /* Buttons */
        .btn-style {
            padding: 12px 18px; border: none; border-radius: 10px;
            font-size: 14px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; display: inline-flex;
            align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .btn-style:hover { opacity: 0.95; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-primary { background-color: var(--info); color: white; box-shadow: var(--shadow-btn); }
        .btn-success { background-color: var(--primary); color: white; box-shadow: 0 4px 8px rgba(0, 184, 148, 0.4); }
        .btn-danger { background-color: var(--danger); color: white; box-shadow: 0 4px 8px rgba(232, 65, 24, 0.4); }
        .btn-warning { background-color: var(--warning); color: var(--text-main); box-shadow: 0 4px 8px rgba(253, 203, 110, 0.4); }
        .btn-settings { width: 100%; margin-top: 5px; justify-content: flex-start; }
        .btn-block { width: 100%; margin-top: 15px; }

        /* Tabs */
        .tab-buttons-container { 
            display: flex; justify-content: space-between;
            background-color: var(--bg-card); padding: 8px;
            border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px; overflow-x: auto;
        }
        .tab-button {
            flex-grow: 0; 
            background-color: transparent; color: var(--text-muted);
            box-shadow: none; padding: 10px 12px; font-size: 13px; font-weight: 600;
            border-radius: 10px; min-width: 40px;
        }
        .tab-button.active { background-color: var(--info); color: white; box-shadow: var(--shadow-btn); }
        .tab-content { display: none; padding-bottom: 30px; } 
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Summary Cards - Clickable */
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .summary-row { margin-bottom: 15px; }
        .summary-item { padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s; }
        .summary-item:active { transform: scale(0.98); }
        .summary-item h3 { font-size: 13px; text-transform: uppercase; margin: 0 0 5px 0; font-weight: 500; color: var(--text-muted); }
        .summary-item p { font-size: 18px; font-weight: 700; margin: 0; }
        
        .yearly-summary { background-color: #E6F0FF; border: 1px solid var(--info); } 
        .income-summary { background-color: #E6FFF6; border: 1px solid var(--primary); } 
        .expense-summary { background-color: #FFF2F2; border: 1px solid var(--danger); } 
        .income-text { color: var(--primary); }
        .expense-text { color: var(--danger); }

        /* Forms */
        label { display: block; margin-bottom: 4px; font-weight: 500; font-size: 13px; color: var(--text-main); }
        input, select, textarea { 
            width: 100%; padding: 12px 14px; font-size: 14px;
            border: 1px solid #DCDCDC; border-radius: 8px;
            box-sizing: border-box; background-color: #FAFAFA;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--info); outline: none; box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.2); }
        .form-grid { display: flex; gap: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group.half { flex: 1; }
        .settings-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .settings-item { margin-bottom: 10px; }

        /* Transactions */
        .transaction-list { list-style: none; padding: 0; margin: 0; }
        .transaction-list li { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #F0F0F0; }
        .transaction-click-area { flex-grow: 1; cursor: pointer; }
        .transaction-info strong { font-size: 15px; }
        .transaction-info span { font-size: 12px; color: var(--text-muted); margin-right: 10px; }
        .transaction-info em { font-size: 12px; font-style: normal; color: #9A9A9A; display: block; margin-top: 3px; }
        .transaction-amount { font-size: 16px; font-weight: 700; }
        .income-item .transaction-amount { color: var(--primary); }
        .expense-item .transaction-amount { color: var(--danger); }
        
        .action-buttons { display: flex; gap: 10px; align-items: center; padding-left: 10px; }
        .edit-btn, .delete-btn { background: none; border: none; cursor: pointer; transition: color 0.2s; font-size: 14px; }
        .delete-btn { color: #ccc; }
        .delete-btn:hover { color: var(--danger); }
        .edit-btn { color: #ccc; }
        .edit-btn:hover { color: var(--info); }

        /* Charts & Custom Legends */
        .chart-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }
        .chart-card { background: var(--bg-card); border-radius: var(--radius); padding: 18px; box-shadow: var(--shadow); margin-bottom: 15px; border: 1px solid #E0E0E0; position: relative; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chart-header h2 { font-size: 18px; font-weight: 600; margin: 0; display: flex; align-items: center; }
        .chart-container { 
            position: relative; height: 250px; width: 100%; 
            padding: 10px 0; overflow: hidden; cursor: pointer;
        } 
        /* Scrollable Legend Styles */
        .custom-legend {
            max-height: 150px; /* Limit height */
            overflow-y: auto;  /* Enable scrolling */
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .legend-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 5px; font-size: 13px; color: var(--text-main);
            border-bottom: 1px dashed #f0f0f0;
            transition: background 0.2s;
            border-radius: 5px;
        }
        .legend-item:hover { background-color: #f9f9f9; }
        .legend-label { display: flex; align-items: center; gap: 8px; }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
        
        /* Modal List Styles (SweetAlert Custom) */
        .swal-list { text-align: left; max-height: 300px; overflow-y: auto; list-style: none; padding: 0; }
        .swal-list li { border-bottom: 1px solid #eee; padding: 8px 0; font-size: 14px; }
        .swal-list strong { display: block; color: var(--text-main); }
        .swal-list span { color: var(--text-muted); font-size: 12px; }
        .swal-amt { float: right; font-weight: bold; }

        /* Security PIN UI */
        #securityOverlay {
            background-color: var(--lock-bg); color: var(--lock-text);
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; 
        }
        .pin-title { font-size: 26px; font-weight: 700; margin-bottom: 40px; }
        .pin-display { font-size: 18px; font-weight: 500; color: var(--text-main); margin-bottom: 15px; } 
        .pin-dots { display: flex; gap: 15px; margin-bottom: 50px; height: 18px; } 
        .pin-dot { width: 15px; height: 15px; border-radius: 50%; border: 3px solid var(--info); background: transparent; transition: all 0.3s; }
        .pin-dot.filled { background: var(--info); border-color: var(--info); box-shadow: 0 0 10px rgba(0, 122, 204, 0.5); }
        
        .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 300px; }
        .pin-btn {
            width: 70px; height: 70px; font-size: 24px; background: var(--bg-card); 
            border: 1px solid #DCDCDC; color: var(--text-main); font-weight: 600;
            border-radius: 50%; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: all 0.2s; user-select: none;
        }
        .pin-btn:active { transform: scale(0.95); background-color: #F0F0F0; }
        .action-btn.red { background: #FFEDED !important; color: var(--danger) !important; border-color: var(--danger) !important; }
        .action-btn.green { background: #EDFFF3 !important; color: var(--primary) !important; border-color: var(--primary) !important; }
        #closePinScreen {
            color: var(--lock-text); position: absolute; top: 25px; right: 25px;
            font-size: 30px; cursor: pointer; opacity: 0.8; transition: opacity 0.2s;
        }
        #closePinScreen:hover { opacity: 1; }
    </style>
</head>
<body>
    <div id="securityOverlay">
        <span id="closePinScreen" onclick="closePinScreen()" style="display: none;"><i class="fas fa-times"></i></span>
        <div class="pin-title"><i class="fas fa-lock"></i> Security Access</div>
        <div class="pin-display">Enter your 4-digit PIN</div>
        <div class="pin-dots" id="pinDots">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
        <div class="pin-pad">
            <div class="pin-btn" onclick="pressPin('1')">1</div>
            <div class="pin-btn" onclick="pressPin('2')">2</div>
            <div class="pin-btn" onclick="pressPin('3')">3</div>
            <div class="pin-btn" onclick="pressPin('4')">4</div>
            <div class="pin-btn" onclick="pressPin('5')">5</div>
            <div class="pin-btn" onclick="pressPin('6')">6</div>
            <div class="pin-btn" onclick="pressPin('7')">7</div>
            <div class="pin-btn" onclick="pressPin('8')">8</div>
            <div class="pin-btn" onclick="pressPin('9')">9</div>
            <div class="pin-btn action-btn red" onclick="pressPin('C')"><i class="fas fa-times"></i></div>
            <div class="pin-btn" onclick="pressPin('0')">0</div>
            <div class="pin-btn action-btn green" onclick="submitPin()"><i class="fas fa-check"></i></div>
        </div>
    </div>

    <div class="container" id="mainAppContent" style="display: none;">
        <header>
            <div class="balance-controls">
                <p style="font-size: 14px; margin: 0; padding-top: 5px;"><span id="balanceTitle">Total Net Balance (Lifetime)</span></p>
                </div>
            <div id="currentBalance" class="balance zero">₹0.00</div>
        </header>

        <div class="tab-buttons-container">
             <button class="tab-button btn-style" id="tabButtonDashboard" onclick="openTab('dashboard', this)"><i class="fas fa-chart-line"></i> Dash</button>
             <button class="tab-button btn-style" id="tabButtonAnalysis" onclick="openTab('analysis', this)"><i class="fas fa-chart-area"></i> Analysis</button>
             <button class="tab-button btn-style" id="tabButtonAdd" onclick="openTab('addTransaction', this)"><i class="fas fa-plus-circle"></i> Add</button>
             <button class="tab-button btn-style" id="tabButtonHistory" onclick="openTab('history', this)"><i class="fas fa-history"></i> Hist</button>
             <button class="tab-button btn-style" id="tabButtonSettings" onclick="openTab('settings', this)"><i class="fas fa-cog"></i></button>
        </div>

        <div id="dashboard" class="tab-content">
            <div class="summary-grid summary-row">
                <div class="card summary-item yearly-summary" onclick="showSummaryDetails('yearly', 'income')">
                    <h3><i class="fas fa-calendar-alt"></i> YEARLY INCOME</h3>
                    <p id="yearlyIncome" class="income-text">₹0.00</p>
                </div>
                <div class="card summary-item yearly-summary" onclick="showSummaryDetails('yearly', 'expense')">
                    <h3><i class="fas fa-calendar-alt"></i> YEARLY EXPENSE</h3>
                    <p id="yearlyExpense" class="expense-text">₹0.00</p>
                </div>
            </div>

            <div class="summary-grid summary-row">
                <div class="card summary-item income-summary" onclick="showSummaryDetails('monthly', 'income')">
                    <h3><i class="fas fa-plus"></i> MONTHLY INCOME</h3>
                    <p id="monthlyIncome" class="income-text">₹0.00</p>
                </div>
                <div class="card summary-item expense-summary" onclick="showSummaryDetails('monthly', 'expense')">
                    <h3><i class="fas fa-minus"></i> MONTHLY EXPENSE</h3>
                    <p id="monthlyExpense" class="expense-text">₹0.00</p>
                </div>
            </div>

            <button class="btn-style btn-primary btn-block" onclick="secureAction(exportDashboardPDF)"><i class="fas fa-file-pdf"></i> EXPORT DASHBOARD PDF</button>

            <div class="chart-grid">
                 <div class="card chart-card">
                    <div class="chart-header">
                        <h2 style="color: var(--primary);"><i class="fas fa-circle-notch"></i> Income Breakdown</h2>
                        <select id="incomeChartFilter" onchange="renderIncomeChart()"></select>
                    </div>
                    <div class="chart-container">
                        <canvas id="incomeChart"></canvas>
                    </div>
                    <div id="incomeLegend" class="custom-legend"></div>
                 </div>

                 <div class="card chart-card">
                    <div class="chart-header">
                        <h2 style="color: var(--danger);"><i class="fas fa-circle-notch"></i> Expense Breakdown</h2>
                        <select id="expenseChartFilter" onchange="renderExpenseChart()"></select>
                    </div>
                    <div class="chart-container">
                        <canvas id="expenseChart"></canvas>
                    </div>
                    <div id="expenseLegend" class="custom-legend"></div>
                 </div>
            </div>
        </div>

        <div id="analysis" class="tab-content">
            <div class="card">
                <div style="margin-bottom:15px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                   <h2 style="font-size: 20px; margin-top: 0; color: var(--info);"><i class="fas fa-chart-bar"></i> Multi-Year Analysis</h2>
                   <label for="analysisYearFilter">Select Base Year:</label>
                   <select id="analysisYearFilter" onchange="renderAllAnalysisCharts()"></select>
                   <p style="font-size:11px; color:#666; margin:5px 0 0;">* Comparing selected year vs previous 2 years.</p>
               </div>

               <div style="margin-bottom:30px;">
                   <h3 style="text-align:center; color:var(--info); font-size:14px; margin-bottom:10px;">Net Balance Trend</h3>
                   <div class="chart-container">
                       <canvas id="balanceChart"></canvas>
                   </div>
               </div>

               <div style="margin-bottom:30px;">
                   <h3 style="text-align:center; color:var(--primary); font-size:14px; margin-bottom:10px;">Income Comparison</h3>
                   <div class="chart-container">
                       <canvas id="incomeCompChart"></canvas>
                   </div>
               </div>

               <div>
                   <h3 style="text-align:center; color:var(--danger); font-size:14px; margin-bottom:10px;">Expense Comparison</h3>
                   <div class="chart-container">
                       <canvas id="expenseCompChart"></canvas>
                   </div>
               </div>
            </div>
       </div>

        <div id="addTransaction" class="tab-content">
             <div class="card">
                <h2 style="font-size: 20px; margin-top: 0; color: var(--info);"><i class="fas fa-plus-circle"></i> Add / Edit Transaction</h2>
                <form id="transactionForm">
                    <div class="form-grid">
                        <div class="form-group half">
                            <label for="amount">Amount (₹):</label>
                            <input type="number" id="amount" placeholder="e.g., 500" required min="1">
                        </div>

                        <div class="form-group half">
                            <label for="type">Type:</label>
                            <select id="type" required>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group half">
                            <label for="category">Category:</label>
                            <select id="category" required></select>
                        </div>
                        <div class="form-group half">
                            <label for="date">Date & Time:</label>
                            <input type="datetime-local" id="date" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="details">Details:</label>
                        <textarea id="details" rows="2" placeholder="e.g., Class fee / Purchase"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" id="saveBtn" class="btn-style btn-success btn-block"><i class="fas fa-save"></i> Save Record</button>
                        <button type="button" id="cancelEditBtn" class="btn-style btn-danger btn-block" style="display: none;" onclick="cancelEdit()"><i class="fas fa-times"></i> Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="history" class="tab-content">
            <div class="card">
                <div class="list-header" style="margin-bottom: 10px;">
                    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h2 style="font-size: 20px; margin: 0; color: var(--text-main); font-weight: 600;"><i class="fas fa-list-ul"></i> History</h2>
                        <div class="form-group" style="margin: 0; width: 50%;">
                            <select id="monthFilter" onchange="renderTransactions()"></select>
                        </div>
                    </div>
                    <div style="margin-top: 5px;">
                        <input type="text" id="searchInput" placeholder="Search (Category, Details, Amount)..." onkeyup="renderTransactions()" style="border: 1px solid var(--info);">
                    </div>
                </div>
                <button class="btn-style btn-primary btn-block" onclick="secureAction(exportHistoryPDF)"><i class="fas fa-file-pdf"></i> Export History PDF</button>
                <ul id="transactionList" class="transaction-list"></ul>
                <p id="noTransactionsMsg" style="text-align: center; color: var(--text-muted); font-style: italic; display: none; padding: 15px;">No transactions found.</p>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <div class="card">
                <h2 style="font-size: 20px; margin-top: 0; color: var(--info);"><i class="fas fa-cogs"></i> App Settings</h2>
                <div class="settings-grid">
                    <div class="settings-item" style="grid-column: span 2;">
                        <label>Update Security PIN</label>
                        <input type="password" id="newAppPin" placeholder="New 4-Digit PIN" maxlength="4" style="margin-bottom: 5px;">
                        <button class="btn-style btn-primary btn-settings" onclick="changeAppPin()"><i class="fas fa-key"></i> Update PIN</button>
                    </div>
                    <div class="settings-item">
                        <label>Data Management</label>
                        <button class="btn-style btn-primary btn-settings" onclick="secureAction(exportData)"><i class="fas fa-download"></i> Export Data</button>
                        <button class="btn-style btn-warning btn-settings" onclick="secureAction(() => document.getElementById('importFile').click())"><i class="fas fa-upload"></i> Import Data</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                        <button class="btn-style btn-danger btn-settings" onclick="secureAction(resetApp)"><i class="fas fa-trash"></i> Reset All Data</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2 style="font-size: 20px; margin-top: 0; color: var(--primary);"><i class="fas fa-tags"></i> Custom Categories</h2>
                <p style="font-size: 13px; color: var(--text-muted);">Define categories for clear tracking.</p>
                <div id="categoryListDisplay" style="margin-bottom: 10px; font-size: 14px;"></div>
                <input type="text" id="newCategoryName" placeholder="New Category Name">
                <button class="btn-style btn-success btn-block" style="margin-top: 10px;" onclick="addCategory()"><i class="fas fa-plus"></i> Add New Category</button>
            </div>
        </div>
    </div>

    <script>
        const DB_NAME = 'ProFinanceDB', DB_VERSION = 1, STORE_TX = 'transactions', STORE_CATS = 'categories', STORE_PIN = 'appSettings';
        const DEFAULT_CATEGORIES = ['Class', 'Shows', 'Others'], DEFAULT_PIN = '1234';
        const INCOME_COLORS = ['#00B894', '#007ACC', '#5DADE2', '#3498DB', '#1ABC9C', '#2ECC71', '#48C9B0', '#76D7C4'];
        const EXPENSE_COLORS = ['#E84118', '#FF7F50', '#F39C12', '#C0392B', '#E74C3C', '#E67E22', '#D35400', '#F9E79F'];
        let db, transactions = [], categories = DEFAULT_CATEGORIES;
        let expenseChartInstance = null, incomeChartInstance = null;
        let balChart = null, incChart = null, expChart = null;
        let dbInitialized = false;
        let editingTransactionId = null;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_TX)) db.createObjectStore(STORE_TX, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains(STORE_CATS)) db.createObjectStore(STORE_CATS, { keyPath: 'name' });
                    if (!db.objectStoreNames.contains(STORE_PIN)) db.createObjectStore(STORE_PIN, { keyPath: 'key' });
                };
                request.onsuccess = (event) => { db = event.target.result; dbInitialized = true; resolve(db); };
                request.onerror = (event) => { reject('Database error: ' + event.target.errorCode); };
            });
        }
        function dbStoreAction(storeName, mode, callback) {
            return new Promise((resolve, reject) => {
                if (!dbInitialized || !db) { reject("DB not initialized."); return; }
                const transaction = db.transaction([storeName], mode);
                const store = transaction.objectStore(storeName);
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
                callback(store, resolve, reject);
            });
        }
        function dbGetAll(storeName) { return new Promise((res, rej) => dbStoreAction(storeName, 'readonly', (s) => { const r = s.getAll(); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }).catch(rej)); }
        function dbSet(storeName, value) { return dbStoreAction(storeName, 'readwrite', (s) => s.put(value)); }
        function dbDelete(storeName, key) { return dbStoreAction(storeName, 'readwrite', (s) => s.delete(key)); }
        function dbGet(storeName, key) { return new Promise((res, rej) => dbStoreAction(storeName, 'readonly', (s) => { const r = s.get(key); r.onsuccess = (e) => res(e.target.result); r.onerror = () => rej(r.error); }).catch(rej)); }

        let pendingAction = null, pinInput = "";
        function updatePinDots() { document.querySelectorAll('.pin-dot').forEach((d, i) => d.classList.toggle('filled', i < pinInput.length)); }
        function pressPin(k) { if (k === 'C') pinInput = ""; else if (pinInput.length < 4) pinInput += k; updatePinDots(); }
        async function getAppPin() { try { await openDB(); const pinRecord = await dbGet(STORE_PIN, 'pin'); return pinRecord ? pinRecord.value : DEFAULT_PIN; } catch (error) { return DEFAULT_PIN; } }
        async function submitPin() {
            if (pinInput.length !== 4) { Swal.fire('Error', 'PIN must be 4 digits.', 'error'); return; }
            try {
                const currentPin = await getAppPin();
                if (pinInput === currentPin) {
                    document.getElementById('securityOverlay').style.display = 'none';
                    document.getElementById('closePinScreen').style.display = 'none';
                    if (pendingAction) { pendingAction(); pendingAction = null; }
                    else if (document.getElementById('mainAppContent').style.display === 'none') initApp();
                } else { Swal.fire('Error', 'Incorrect PIN', 'error'); }
            } catch (e) { Swal.fire('Error', 'Database access failed. Please restart app.', 'error'); }
            pinInput = ""; updatePinDots();
        }
        function closePinScreen() { document.getElementById('securityOverlay').style.display = 'none'; pinInput = ""; updatePinDots(); pendingAction = null; }
        async function secureAction(cb) { pendingAction = cb; pinInput = ""; updatePinDots(); await openDB(); document.getElementById('closePinScreen').style.display = 'block'; document.getElementById('securityOverlay').style.display = 'flex'; }

        const formatCurrency = (amt) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amt || 0);
        const formatSimple = (amt) => new Intl.NumberFormat('en-IN', { minimumFractionDigits: 2 }).format(amt || 0);
        const getYM = (d) => d.substring(0, 7);
        const getY = (d) => d.substring(0, 4);
        
        function setDateTimeLocalNow() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('date').value = now.toISOString().slice(0, 16);
        }

        async function loadFromDB() {
            await openDB();
            transactions = await dbGetAll(STORE_TX) || [];
            const savedCats = await dbGetAll(STORE_CATS);
            categories = (savedCats && savedCats.length) ? savedCats.map(c => c.name) : DEFAULT_CATEGORIES;
            if (!savedCats || !savedCats.length) { const catPromises = DEFAULT_CATEGORIES.map(c => dbSet(STORE_CATS, { name: c })); await Promise.all(catPromises); }
            const pin = await dbGet(STORE_PIN, 'pin');
            if (!pin) await dbSet(STORE_PIN, { key: 'pin', value: DEFAULT_PIN });
        }

        function openTab(name, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(name).classList.add('active');
            btn.classList.add('active');
            if (name === 'dashboard') { populateChartFilters(); renderIncomeChart(); renderExpenseChart(); }
            else if (name === 'history') { populateChartFilters(); renderTransactions(); }
            else if (name === 'settings') renderCategoryList();
            else if (name === 'analysis') { populateAnalysisYear(); requestAnimationFrame(() => { requestAnimationFrame(() => { renderAllAnalysisCharts(); }); }); }
            updateSummary();
        }

        function updateSummary() {
            const now = new Date(), curM = getYM(now.toISOString()), curY = now.getFullYear().toString();
            const prevY = (now.getFullYear() - 1).toString();
            const activeTab = document.querySelector('.tab-content.active')?.id;
            let mInc=0, mExp=0, yInc=0, yExp=0, lInc=0, lExp=0, pYInc=0, pYExp=0, fInc=0, fExp=0;
            const filterVal = document.getElementById('monthFilter')?.value || curM;

            transactions.forEach(t => {
                const ym = getYM(t.date), y = getY(t.date);
                if (t.type === 'income') { lInc += t.amount; if (y === curY) yInc += t.amount; if (y === prevY) pYInc += t.amount; if (ym === curM) mInc += t.amount; }
                else { lExp += t.amount; if (y === curY) yExp += t.amount; if (y === prevY) pYExp += t.amount; if (ym === curM) mExp += t.amount; }
                let include = false;
                if (filterVal === 'lifetime') include = true;
                else if (filterVal === 'current_year') include = (y === curY);
                else if (filterVal.length === 4) include = (y === filterVal);
                else include = (ym === filterVal);
                if (include) { if(t.type==='income') fInc+=t.amount; else fExp+=t.amount; }
            });

            document.getElementById('yearlyIncome').textContent = formatCurrency(yInc);
            document.getElementById('yearlyExpense').textContent = formatCurrency(yExp);
            document.getElementById('monthlyIncome').textContent = formatCurrency(mInc);
            document.getElementById('monthlyExpense').textContent = formatCurrency(mExp);

            let bal = lInc - lExp, title = 'Total Net Balance (Lifetime)';
            if (activeTab === 'settings') { bal = pYInc - pYExp; title = `Net Balance (Year ${prevY})`; }
            else if (activeTab === 'addTransaction') { bal = yInc - yExp; title = 'Net Balance (Current Year)'; }
            else if (activeTab === 'history') { bal = fInc - fExp; title = 'Net Balance (Selected Period)'; }
            else if (activeTab === 'analysis') {
                const selectedYear = document.getElementById('analysisYearFilter').value;
                if(selectedYear) {
                    let ayInc = 0, ayExp = 0;
                    transactions.forEach(t => { if(getY(t.date) === selectedYear) { if(t.type === 'income') ayInc += t.amount; else ayExp += t.amount; } });
                    bal = ayInc - ayExp; title = `Net Balance (${selectedYear})`;
                } else { bal = lInc - lExp; title = 'Net Balance (Lifetime)'; }
            }
            const balEl = document.getElementById('currentBalance');
            balEl.textContent = formatCurrency(bal);
            document.getElementById('balanceTitle').textContent = title;
            balEl.className = `balance ${bal > 0 ? 'positive' : (bal < 0 ? 'negative' : 'zero')}`;
        }

        function populateChartFilters() {
            const cur = new Date(), curM = getYM(cur.toISOString()), curY = cur.getFullYear().toString();
            const periods = new Set([curY, curM]);
            transactions.forEach(t => { periods.add(getY(t.date)); periods.add(getYM(t.date)); });
            const arr = Array.from(periods).sort().reverse();
            
            ['incomeChartFilter', 'expenseChartFilter'].forEach(id => {
                const sel = document.getElementById(id); sel.innerHTML = '';
                arr.forEach(p => sel.add(new Option(p.length===4 ? `Year ${p}` : new Date(p+"-01").toLocaleDateString('en-IN',{month:'long',year:'numeric'}), p)));
                const saved = localStorage.getItem('pref_' + id);
                sel.value = (saved && [...sel.options].some(o => o.value === saved)) ? saved : curM;
                sel.onchange = function() {
                    localStorage.setItem('pref_' + id, this.value);
                    if(id === 'incomeChartFilter') renderIncomeChart(); else renderExpenseChart();
                };
            });

            const hist = document.getElementById('monthFilter'); hist.innerHTML = '';
            hist.add(new Option('--- VIEW TRANSACTIONS ---', ''));
            hist.add(new Option('All Transactions (Lifetime)', 'lifetime'));
            hist.add(new Option('All Months (Current Year)', 'current_year'));
            arr.forEach(p => hist.add(new Option(p.length===4 ? `Year ${p} Total` : new Date(p+"-01").toLocaleDateString('en-IN',{month:'long',year:'numeric'}), p)));
            
            const savedHist = localStorage.getItem('pref_monthFilter');
            hist.value = (savedHist && [...hist.options].some(o => o.value === savedHist)) ? savedHist : curM;
            
            hist.onchange = function() {
                localStorage.setItem('pref_monthFilter', this.value);
                renderTransactions();
            };
        }

        Chart.register({
            id: 'centerText',
            beforeDraw: (chart) => {
                if (chart.config.options.elements?.center) {
                    const ctx = chart.ctx, { width, height } = chart;
                    ctx.save();
                    ctx.font = '700 24px Poppins'; ctx.fillStyle = chart.config.options.elements.center.color; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText(chart.config.options.elements.center.text, width/2, height/2 - 10);
                    ctx.font = '500 12px Poppins'; ctx.fillStyle = '#666';
                    ctx.fillText(chart.config.options.elements.center.label, width/2, height/2 + 15);
                    ctx.restore();
                }
            }
        });

        function renderChart(type, canvasId, filterId) {
            const filter = document.getElementById(filterId).value;
            const isY = filter.length === 4;
            const dataMap = {};
            transactions.filter(t => t.type === type && (isY ? getY(t.date) === filter : getYM(t.date) === filter)).forEach(t => {
                dataMap[t.category || 'Others'] = (dataMap[t.category || 'Others'] || 0) + t.amount;
            });
            const labels = Object.keys(dataMap), data = Object.values(dataMap);
            const total = data.reduce((a, b) => a + b, 0);
            
            // Render Legend manually to allow scrolling & Click event
            const legendContainer = document.getElementById(type === 'income' ? 'incomeLegend' : 'expenseLegend');
            const colors = type === 'income' ? INCOME_COLORS : EXPENSE_COLORS; 
            
            let legendHTML = '';
            if (total === 0) {
                legendHTML = '<p style="text-align:center;color:#ccc;font-size:12px;">No data</p>';
            } else {
                labels.forEach((label, i) => {
                    const pct = Math.round(data[i]/total*100);
                    const color = colors[i % colors.length];
                    // Added onClick here to show details
                    legendHTML += `
                        <div class="legend-item" style="cursor: pointer;" onclick="showCategoryHistory('${label}', '${type}', '${filter}')">
                            <div class="legend-label">
                                <div class="legend-color" style="background:${color}"></div>
                                <span>${label} (${pct}%)</span>
                            </div>
                            <span style="font-weight:600">${formatCurrency(data[i])}</span>
                        </div>`;
                });
            }
            legendContainer.innerHTML = legendHTML;

            const container = document.getElementById(canvasId).parentElement;
            if (total === 0) { 
                const ctx = document.getElementById(canvasId).getContext('2d');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return; 
            }
            
            const ctx = document.getElementById(canvasId).getContext('2d');
            const instance = type === 'expense' ? expenseChartInstance : incomeChartInstance;
            if (instance) instance.destroy();
            
            const newChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: colors }] },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '70%',
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { enabled: true }
                    },
                    elements: { center: { text: formatCurrency(total), label: `Total ${type}`, color: type==='income'?'#00B894':'#E84118' } },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const category = labels[index];
                            showCategoryHistory(category, type, filter);
                        }
                    }
                }
            });
            if (type === 'expense') expenseChartInstance = newChart; else incomeChartInstance = newChart;
        }
        function renderIncomeChart() { renderChart('income', 'incomeChart', 'incomeChartFilter'); }
        function renderExpenseChart() { renderChart('expense', 'expenseChart', 'expenseChartFilter'); }

        function showCategoryHistory(category, type, filterPeriod) {
            const isY = filterPeriod.length === 4;
            const filtered = transactions.filter(t => 
                t.type === type && 
                t.category === category && 
                (isY ? getY(t.date) === filterPeriod : getYM(t.date) === filterPeriod)
            ).sort((a,b) => new Date(b.date) - new Date(a.date));
            
            showTransactionsModal(`${category} - ${type.toUpperCase()}`, filtered);
        }

        function showSummaryDetails(scope, type) {
            const now = new Date();
            const curY = now.getFullYear().toString();
            const curM = getYM(now.toISOString());
            
            const filtered = transactions.filter(t => {
                const ym = getYM(t.date), y = getY(t.date);
                if (t.type !== type) return false;
                if (scope === 'yearly') return y === curY;
                if (scope === 'monthly') return ym === curM;
                return false;
            }).sort((a,b) => new Date(b.date) - new Date(a.date));
            
            const title = `${scope === 'yearly' ? 'Yearly' : 'Monthly'} ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            showTransactionsModal(title, filtered);
        }

        function showTransactionsModal(title, list) {
            let htmlContent = '<ul class="swal-list">';
            if (list.length === 0) {
                htmlContent += '<li style="text-align:center;">No transactions found.</li>';
            } else {
                list.forEach(t => {
                    const dateStr = new Date(t.date).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' });
                    htmlContent += `
                        <li>
                            <span class="swal-amt">${formatCurrency(t.amount)}</span>
                            <strong>${t.category}</strong>
                            <span>${dateStr}</span>
                            ${t.details ? `<br><span style="font-style:italic;">"${t.details}"</span>` : ''}
                        </li>`;
                });
            }
            htmlContent += '</ul>';
            
            Swal.fire({
                title: title,
                html: htmlContent,
                showCloseButton: true,
                focusConfirm: false,
                confirmButtonText: 'Close',
                customClass: { popup: 'swal-wide' }
            });
        }

        function populateAnalysisYear(){
            const sel = document.getElementById('analysisYearFilter');
            const curr = new Date().getFullYear();
            const years = [...new Set(transactions.map(t=>getY(t.date)))];
            if(!years.includes(String(curr))) years.push(String(curr));
            years.sort((a,b)=>b-a);
            const saved = sel.value; sel.innerHTML='';
            years.forEach(y=> sel.add(new Option(y,y)));
            const savedPref = localStorage.getItem('pref_analysisYearFilter');
            const defaultYear = String(curr);
            sel.value = (savedPref && [...sel.options].some(o => o.value === savedPref)) ? savedPref : defaultYear;
            sel.onchange = function() {
                localStorage.setItem('pref_analysisYearFilter', this.value);
                renderAllAnalysisCharts();
            };
        }
        function getMonthlyData(year, type){
            const data = Array(12).fill(0);
            transactions.filter(t=>t.date.startsWith(year)).forEach(t=>{
                const m = parseInt(t.date.substring(5,7))-1;
                if(type==='balance') data[m] += (t.type==='income'?t.amount:-t.amount);
                else if(t.type===type) data[m] += t.amount;
            });
            return data;
        }
        function renderAllAnalysisCharts(){
            const base = document.getElementById('analysisYearFilter').value;
            updateSummary();
            if(!base) return;
            const years = [base, String(base-1), String(base-2)];
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const createDS = (lbl, type, color, dash) => ({
                label: lbl, data: getMonthlyData(lbl, type),
                borderColor: color, borderWidth: dash?2:3, borderDash: dash?[5,5]:[], tension:0.3, fill:false, pointRadius: dash?0:3
            });
            const balDS = years.map((y,i)=>createDS(y, 'balance', i===0?'#007ACC':(i===1?'#74B9FF':'#BDC3C7'), i>0));
            renderLine('balanceChart', months, balDS, balChart, c => balChart = c);
            const incDS = years.map((y,i)=>createDS(y, 'income', i===0?'#00B894':(i===1?'#55EFC4':'#BDC3C7'), i>0));
            renderLine('incomeCompChart', months, incDS, incChart, c => incChart = c);
            const expDS = years.map((y,i)=>createDS(y, 'expense', i===0?'#E84118':(i===1?'#FAB1A0':'#BDC3C7'), i>0));
            renderLine('expenseCompChart', months, expDS, expChart, c => expChart = c);
        }
        function renderLine(id, lbls, ds, instance, setInst){
            const cvs = document.getElementById(id);
            if(!cvs) return;
            cvs.width = cvs.parentElement.clientWidth;
            cvs.height = cvs.parentElement.clientHeight;
            if(instance) instance.destroy();
            const ctx = cvs.getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: { labels: lbls, datasets: ds },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode:'index', intersect:false }, scales:{ y:{beginAtZero:true} }, plugins:{ legend:{position:'bottom'} } }
            });
            setInst(chart);
        }

        function renderTransactions() {
            const filter = document.getElementById('monthFilter').value;
            const searchInput = document.getElementById('searchInput'); // Get Search Input
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

            const list = document.getElementById('transactionList');
            const filtered = transactions.filter(t => {
                // 1. Date Filter Logic
                let dateMatch = false;
                if(filter==='lifetime') dateMatch = true;
                else if(filter==='current_year') dateMatch = (getY(t.date) === new Date().getFullYear().toString());
                else if(filter.length===4) dateMatch = (getY(t.date) === filter);
                else dateMatch = (getYM(t.date) === (filter || getYM(new Date().toISOString())));

                // 2. Search Filter Logic
                let searchMatch = true;
                if (searchTerm) {
                    const searchStr = (t.category + ' ' + (t.details || '') + ' ' + t.amount).toLowerCase();
                    searchMatch = searchStr.includes(searchTerm);
                }

                return dateMatch && searchMatch;
            }).sort((a,b)=>new Date(b.date)-new Date(a.date));

            list.innerHTML = '';
            document.getElementById('noTransactionsMsg').style.display = filtered.length ? 'none' : 'block';
            filtered.forEach(t => {
                const li = document.createElement('li');
                li.className = t.type === 'income' ? 'income-item' : 'expense-item';
                const dateDisplay = new Date(t.date).toLocaleDateString('en-IN', {day:'numeric', month:'short'});
                
                li.innerHTML = `
                    <div class="transaction-click-area" onclick="showDetails(${t.id})">
                        <div class="transaction-info"><strong>${t.category}</strong><span>${dateDisplay}</span>${t.details ? `<em>${t.details.substring(0,15)}${t.details.length>15?'...':''}</em>` : ''}</div>
                        <div class="transaction-amount">${t.type==='income'?'+':'-'} ${formatCurrency(t.amount)}</div>
                    </div>
                    <div class="action-buttons">
                        <button class="edit-btn" onclick="editTransaction(${t.id})"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn" onclick="deleteTransaction(${t.id})"><i class="fas fa-trash-alt"></i></button>
                    </div>`;
                list.appendChild(li);
            });
            updateSummary();
        }

        function showDetails(id) {
            const t = transactions.find(x => x.id === id);
            if(!t) return;
            const fullDate = new Date(t.date).toLocaleString('en-IN', { dateStyle: 'full', timeStyle: 'short' });
            Swal.fire({
                title: t.category,
                html: `
                    <div style="text-align:left; font-size:15px;">
                        <p><strong>Type:</strong> ${t.type.toUpperCase()}</p>
                        <p><strong>Amount:</strong> <span style="color:${t.type==='income'?'#00B894':'#E84118'};font-weight:bold;font-size:18px;">${formatCurrency(t.amount)}</span></p>
                        <p><strong>Date:</strong> ${fullDate}</p>
                        <p><strong>Details:</strong> ${t.details || 'N/A'}</p>
                    </div>
                `,
                confirmButtonColor: 'var(--info)'
            });
        }

        function editTransaction(id) {
            const t = transactions.find(x => x.id === id);
            if(!t) return;
            document.getElementById('amount').value = t.amount;
            document.getElementById('type').value = t.type;
            document.getElementById('category').value = t.category;
            document.getElementById('date').value = t.date; 
            document.getElementById('details').value = t.details;
            editingTransactionId = id;
            
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Update Record';
            document.getElementById('cancelEditBtn').style.display = 'block';
            openTab('addTransaction', document.getElementById('tabButtonAdd'));
        }

        function cancelEdit() {
            editingTransactionId = null;
            document.getElementById('transactionForm').reset();
            setDateTimeLocalNow();
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Record';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        async function addTransaction(e) {
            e.preventDefault();
            const amt = parseFloat(document.getElementById('amount').value);
            const type = document.getElementById('type').value, cat = document.getElementById('category').value;
            const date = document.getElementById('date').value, dets = document.getElementById('details').value;
            if (amt <= 0 || !cat || !date) { Swal.fire('Error', 'Invalid Input', 'error'); return; }
            
            if (editingTransactionId) {
                const index = transactions.findIndex(t => t.id === editingTransactionId);
                if(index !== -1) {
                    transactions[index] = { id: editingTransactionId, amount: amt, type, category: cat, date, details: dets };
                    await dbSet(STORE_TX, transactions[index]);
                    Swal.fire('Updated', '', 'success');
                }
            } else {
                const tx = { id: Date.now(), amount: amt, type, category: cat, date, details: dets };
                transactions.push(tx); await dbSet(STORE_TX, tx);
                Swal.fire('Saved', '', 'success');
            }
            cancelEdit(); 
            openTab('dashboard', document.getElementById('tabButtonDashboard'));
        }
        
        async function deleteTransaction(id) {
            Swal.fire({ title: 'Delete?', icon: 'warning', showCancelButton: true }).then(async r => {
                if (r.isConfirmed) { transactions = transactions.filter(t => t.id !== id); await dbDelete(STORE_TX, id); renderTransactions(); renderIncomeChart(); renderExpenseChart(); updateSummary(); }
            });
        }
        
        function renderCategoryList() {
            const d = document.getElementById('categoryListDisplay');
            d.innerHTML = categories.length ? `<ul>${categories.map(c => `<li style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #eee"><span>${c}</span><i class="fas fa-trash" style="color:red;cursor:pointer" onclick="removeCategory('${c}')"></i></li>`).join('')}</ul>` : 'No categories.';
        }
        async function addCategory() {
            const n = document.getElementById('newCategoryName').value.trim();
            if (n && !categories.includes(n)) { categories.push(n); await dbSet(STORE_CATS, {name:n}); renderCategoryList(); updateCatOpts(); document.getElementById('newCategoryName').value=''; Swal.fire('Added'); }
        }
        async function removeCategory(n) {
             Swal.fire({ title: 'Delete Category?', showCancelButton: true }).then(async r => {
                if (r.isConfirmed) { categories = categories.filter(c => c !== n); await dbDelete(STORE_CATS, n); renderCategoryList(); updateCatOpts(); }
            });
        }
        function updateCatOpts() {
            const s = document.getElementById('category'); s.innerHTML = '';
            categories.forEach(c => s.add(new Option(c, c)));
        }
        async function changeAppPin() {
            const p = document.getElementById('newAppPin').value;
            if (p.length === 4) { await dbSet(STORE_PIN, {key:'pin', value:p}); Swal.fire('PIN Updated'); document.getElementById('newAppPin').value=''; }
        }
        async function resetApp() {
            Swal.fire({ title: 'RESET ALL?', text:'Irreversible!', icon:'warning', showCancelButton:true }).then(async r=>{
                if(r.isConfirmed){ await dbStoreAction(STORE_TX, 'readwrite', s=>s.clear()); await dbStoreAction(STORE_CATS, 'readwrite', s=>s.clear()); await dbStoreAction(STORE_PIN, 'readwrite', s=>s.clear()); window.location.reload(); }
            });
        }
        
        function checkFilePickerSupport() {
            if (typeof window.showSaveFilePicker === 'undefined') { Swal.fire({ title: 'Browser Not Supported', text: 'Use Chrome, Edge or a modern desktop browser.', icon: 'error' }); return false; }
            return true;
        }
        async function exportData() {
            if (!checkFilePickerSupport()) return;
            const data = { transactions, categories, pin: await getAppPin() };
            const jsonStr = JSON.stringify(data, null, 2); 
            const defaultDate = new Date().toISOString().split('T')[0];
            try {
                const handle = await window.showSaveFilePicker({ suggestedName: `finance_backup_${defaultDate}.json`, types: [{ description: 'JSON Backup File', accept: { 'application/json': ['.json'] } }], });
                const writable = await handle.createWritable(); await writable.write(jsonStr); await writable.close();
                Swal.fire('Success', 'Backup saved successfully.', 'success');
            } catch (err) { if (err.name !== 'AbortError') Swal.fire('Error', 'Failed to save backup.', 'error'); }
        }
        function importData(e) {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = async (ev) => {
                try {
                    const d = JSON.parse(ev.target.result);
                    if(d.transactions) { await dbStoreAction(STORE_TX, 'readwrite', s=>s.clear()); for(const t of d.transactions) await dbSet(STORE_TX, t); }
                    if(d.categories) { await dbStoreAction(STORE_CATS, 'readwrite', s=>s.clear()); for(const c of d.categories) await dbSet(STORE_CATS, {name:c}); }
                    if(d.pin) await dbSet(STORE_PIN, {key:'pin', value:d.pin});
                    window.location.reload();
                } catch(err) { Swal.fire('Error', 'Invalid File', 'error'); }
            };
            r.readAsText(f);
        }

        function exportDashboardPDF(){
             const doc = new window.jspdf.jsPDF(); 
             doc.text("Pro Finance by Srikanta Banerjee", 14, 20); 
             doc.autoTable({ startY: 30, head: [['Metric', 'Value']], body: [ ['Yearly Income', document.getElementById('yearlyIncome').textContent], ['Yearly Expense', document.getElementById('yearlyExpense').textContent], ['Net Balance', document.getElementById('currentBalance').textContent] ]});
             doc.save(`dashboard_${new Date().toISOString().split('T')[0]}.pdf`);
        }
        function exportHistoryPDF(){
             const doc = new window.jspdf.jsPDF(); 
             doc.text("Pro Finance by Srikanta Banerjee", 14, 20); 
             // Updated to handle full datetime string
             const rows = transactions.map(t => {
                 const dateStr = new Date(t.date).toLocaleString('en-IN');
                 return [dateStr, t.category, t.type, t.amount, t.details || ''];
             });
             doc.autoTable({ startY: 30, head: [['Date', 'Category', 'Type', 'Amount', 'Details']], body: rows });
             doc.save(`history_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        async function initApp() {
            await loadFromDB();
            setDateTimeLocalNow(); // Set current date/time on load
            document.getElementById('transactionForm').addEventListener('submit', addTransaction);
            renderCategoryList(); updateCatOpts(); renderTransactions();
            document.getElementById('mainAppContent').style.display = 'block';
            openTab('dashboard', document.getElementById('tabButtonDashboard'));
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try { await openDB(); const pin = await dbGet(STORE_PIN, 'pin'); if(!pin) await dbSet(STORE_PIN, {key:'pin', value:DEFAULT_PIN}); } catch(e) { console.log('Init DB error', e); }
            document.getElementById('securityOverlay').style.display = 'flex';
            document.getElementById('closePinScreen').style.display = 'none';
            if('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('service-worker.js').catch(err => console.log('SW failed: ', err)); }); }
        });
    </script>
</body>
</html>
